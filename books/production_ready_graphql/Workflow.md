## Workflow

チームが成長するにつれてAPIの品質を高く保つことは挑戦であり、最初から最後まで全体的に考えなければ達成されることは稀です。この章では、あなたのチームや組織に合ったフローを開発するための道筋となる、重要なワークフローの部分をカバーします。各チームは異なる方法で働いていますので、これは決して絶対的な推奨事項ではありませんが、これらは私が数年にわたりうまくいっていると感じている実践です。

### Design

既にこの本で何度も触れてきましたが、注意深い設計はAPIが時間を経ても耐えられ、安定し、クライアントによる理解と使用が容易になることを保証するための大きな一歩です。この章で覚えておくべきことが１つだけとしたら、それは私がGraphQL APIを作業するどんなチームに対しても絶対に推奨するものです。もちろん、前もって過度に設計することは理想的ではない場合もあります。しかし私の経験上、ほとんどのチームはAPIの機能の実装に早々と取り掛かる傾向があります。もっと前もって設計をしたり、少なくともその主題について何度か議論を交わすことで、後々生じる可能性のある多くの問題を避けることができます。
具体的には、ワークフローにおいて、このように効果的にするためのいくつかの異なる方法を見てきました：

- GitHubのissuesやその他の共有ドキュメントは、初期設計（SDLを使用して）を投稿し、議論するのに最適です。
- プロジェクトマネージャーやデザイナー、ドキュメンテーション専門家などを、プロセスの可能な限り早い段階で巻き込む。

新しい機能に対するスキーマを設計したら、それを目に触れる機会を作ることが次のステップです。

### Review

スキーマのレビューは、提案された設計がさまざまな人々にとって理解しやすいものであることを確認するための素晴らしい方法です。希望的観測では、リンターがあることで曖昧さを取り除き、バイクシェッド（個々の意見を押し通そうとする議論）を防ぐために、スキーマが一貫性を保つことを助けているはずです。代わりに、レビュアーは核となる設計に思考を向けるべきで、これは自動化ツールではあまりうまく対処できません。
レビュアーは誰であるべきでしょうか？この本を読んでいるあなたがその1人かもしれません！しかし、組織やチームが成長するにつれて、「GraphQLの専門家」の数が毎週、または毎日進行中のすべてのAPI変更をレビューするのに十分でない場合が多いでしょう。レビューチームは最初はうまく機能しますが、スケールするのは難しいです。レビューがますます多くの時間を取るようになったら、それはスキーマ/APIの品質ツールへの投資の時期かもしれません。
全体的に、私たちの目標は常に、最初から「間違ったことをするのが難しい」品質のツールと素晴らしいスキーマ定義APIを構築することです。

ある時点で私たちは以下の事を信頼しなければなりません：

- チームメンバーはGraphQLと良好なAPI設計について学ぶための適切なドキュメンテーションがある
- 彼らが使用するAPIとツールは自然に彼らをベストプラクティスへと導く

### Development

理想的には、新しいユースケースの理想的な設計について合意した後に開発フェーズが始まります。可能であれば、その時点より前にどのように構築するかを考えることを避けてください。なぜなら、実装の詳細が我々の設計に影響を与えることを望んでいないからです。これは常に可能なわけではありませんが。開発フェーズに関して付け加えるべきことはほとんどありません。私たちがこれまで本の中で見てきたアドバイスのいくつかに従っていれば、良い道筋にいることでしょう！

### Publish

あなたは自分のデザインに自信を持っており、チームがGraphQLスキーマを実装し、ツールとレビュアーがあなたのスキーマが高品質であることを確認しています。次に何をすべきでしょうか？それはそれを公開する時が来たということです。単一のクライアントと作業している場合、このステップは通常非常に簡単で、新しいユースケースと統合するために直接グローバルに変更をデプロイすることができます。
多数のクライアントを扱っている場合、または公開APIの場合、これらのような変更を加えるにはもっと計画が必要かもしれません。このフェーズの目標は、全てのトラフィックを通過させる前に、我々の設計と実装に自信を持つことです。ターゲット指向からより広範囲にわたる3つのテクニックをカバーしましょう。

#### Mock Server

モックサーバーはあなたのGraphQLインタフェースに従うサーバーですが、実際のデータを背後で提供したり変更したりすることはありません。実際のプロダクションデータで間違いを犯すリスクなしに、全ての変更をデプロイする必要なく既知のクライアントと設計を検証するために非常に役立ちます。モックサーバーはAPIの世界では新しいアイデアではありませんが、型システムにより、GraphQLは「フェイク」インターフェースを作ることを容易にしています。

Apolloの素晴らしいユーティリティであるgraphql-toolsは、JavaScriptを使用してシンプルなGraphQLモックサーバーを構築するための素晴らしい選択肢です。GraphQL-Fakerは別のプロジェクトで、GraphQLスキーマがあればCLIとして使用してすぐにモックサーバーを作成することができます。それはさらに、フェイクデータ生成を助けるカスタムディレクティブでスキーマに注釈を付けることを可能にします：

```graphql
type Person {
  name: String @fake(type: firstName)
  gender: String @examples(values: ["male", "female"])
  pets: [Pet] @listLength(min: 1, max: 10)
}
```

これらのツールや自身のモックサーバーツールをCIに統合することで、このアイデアをさらに推し進めることができます。"スキーマをアーティファクトとして扱う"アプローチを使用している場合、CIはこのアーティファクトを引っ張り込むことができ、我々がスキーマを本番環境に配布する前にチームにモックサーバーURLを提供できます。

#### Feature Flags

モックサーバーは内部チームと共有するのには素晴らしいですが、パートナーや外部クライアントと共有するのには最適ではありません。誰もが我々のクライアントに開かれていない状態で、彼らに本物を提供したいことがあります。これにはこの本の前半で取り上げたフィーチャーフラグとスキーマ可視性が完璧な解決策です。
フィーチャーフラグを使用することで特定のクライアントと作業を行うことができ、既存の他のクライアントに対してこれらの新しいユースケースが見つけられないようにするために、我々が探索したスキーマ可視性技術を使用します。これはデザインの検証に非常に助けになります。まず内部のクライアントと作業することは素晴らしいことですが、外部の目では私たちが考え付かなかった新たな問題が発生することがよくあります。このアプローチの美点は、私たちは新しく追加されたスキーマの部分を選ばれたパートナーだけに開放しているので、直接彼らと連絡を取ってブレーキングチェンジを行うことができるということです。これはすでにスキーマが全てのクライアントに公開された後では非常に困難なことです。

#### API Previews

最終的に、APIプレビューはフィーチャーフラグのアプローチに似ていますが、誰でも使用することを意図しています。プレビューをサポートするAPIプロバイダーは、新しい機能を試してみてスキーマが一般的に利用可能になる前に有益なフィードバックを得られることを期待して、これらを公表することがよくあります。特にセレクトパートナーや内部アプリケーションと作業する時とは対照的に、あなたがあまり知らない大規模なクライアントプールを持っている場合にフィードバックを集めるための非常に有用な手法となり得ます。
通常これらはHTTPヘッダーを通じて実装されます。クライアントは、FooCorp-API-Preview: new-cool-featureというヘッダーを提供することで、プレビュー中のAPIへのアクセスを有効にすることができます。GraphQLでは、これは通常、通常は隠されているグラフの一部です。再度言いますが、これはスキーマの可視性フィルターを設定している場合には簡単です。なぜなら、ランタイムでスキーマの部分を隠したり表示したりするロジックが必要だからです：

```graphql
type Query {
  newFeature: NewShinyFeature!
    @preview(name: "new-shiny-feature")
}
type NewShinyFeature @preview(name: "new-shiny-feature") {
  field: String!
}
```

実装はフィーチャーフラグとほぼまったく同じですが、背後にあるアイデアは異なります。APIプレビューは新しいユースケースのフィードバックを集める良い方法であると警告しなければなりませんが、それは非常に簡単に乱用されます。プレビューが速やかに卒業されるように確認してください。そうしないと、彼らは自然にAPIの一部となり、多くのクライアントがそのフィールドを使用していますので、我々はそれをほとんど変更することができないという奇妙な状況でAPIの一部となりますが、そのフィールドは依然として"プレビューモード"としてマークされています。プレビュー期間から何を得たいのか、ユーザーやデータから情報を取得し、アイデアが検証されたらすぐにGA（一般利用可能）へ移行することを確認してください。
プレビューは公開APIには有用かもしれませんが、内部APIやパートナーAPIの場合、フィーチャーフラグの方が一般的にはずっと良いアイデアです。

### Analyze

素晴らしいスキーマを設計し、それを実装し、限定された観客や世界中にそれを公開しました！まだ終わりではありません。ツールチャプターで取り上げたスキーマ分析の一部を実装したら、これらの新しいユースケースが時間とともにどのように使用されるかを観察することができます。新機能のパフォーマンスはどうですか？それは使われていますか？最大のユーザーに連絡して何が改善できるかを見つけることができますか？これらはすべて、GraphQLの宣言的性質のおかげで非常にうまく答えることができる素晴らしい質問です。しばしば、新しいユースケースや機能が、インテグレーターが彼らの目標を達成するために通る必要がある回避策から見つけることができます。APIを使用しているチームやクライアントに連絡を取り、新しい機能が全ての人に利用可能になる前に重要な変更を加える時です。

### Ship

新しいAPIをすべての人に公開する時がきました。実際のユースケースとステークホルダー、ドメイン専門家を考慮に入れて慎重に設計し、コードレビューと自動リンターで品質を確認し、十分にテストして、発見的なドキュメンテーションとPlaygroundサーバーを用意しました。それから制限された観客やパートナーと一緒に検証し、そのフィードバックに基づいて改善しました。